<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="高级多人实时聊天应用，支持文本、语音和图片消息，具有在线状态显示和精美UI设计">
    <meta name="keywords" content="多人聊天, 实时通讯, 语音聊天, 图片分享, 在线聊天">
    <meta name="author" content="聊天应用团队">
    <meta property="og:title" content="高级多人实时聊天应用">
    <meta property="og:description" content="体验流畅的多人实时聊天，支持文本、语音和图片消息">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="高级多人实时聊天应用">
    <meta name="twitter:description" content="体验流畅的多人实时聊天，支持文本、语音和图片消息">
    <title>高级多人实时聊天 | 互动交流平台</title>
    <link rel="canonical" href="https://yourdomain.com/free/detail/chat-app">
    <link rel="sitemap" type="application/xml" href="/sitemap.html">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // 配置Tailwind
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: {
                            100: '#374151',
                            200: '#1F2937',
                            300: '#111827',
                            400: '#030712'
                        },
                        light: {
                            100: '#F9FAFB',
                            200: '#F3F4F6',
                            300: '#E5E7EB',
                            400: '#D1D5DB'
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'bounce-light': 'bounceLight 1.5s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceLight: {
                            '0%, 100%': { transform: 'translateY(-5%)' },
                            '50%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thumb-rounded {
                scrollbar-width: thin;
                scrollbar-color: theme('colors.primary/50') transparent;
            }
            .scrollbar-thumb-rounded::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }
            .scrollbar-thumb-rounded::-webkit-scrollbar-thumb {
                background-color: theme('colors.primary/50');
                border-radius: 2px;
            }
            .scrollbar-thumb-rounded::-webkit-scrollbar-track {
                background: transparent;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .bg-gradient-messenger {
                background: linear-gradient(180deg, rgba(59,130,246,0.05) 0%, rgba(139,92,246,0.03) 100%);
            }
            .dark .bg-gradient-messenger {
                background: linear-gradient(180deg, rgba(59,130,246,0.03) 0%, rgba(139,92,246,0.02) 100%);
            }
            .typing-indicator {
                display: inline-flex;
                align-items: center;
                gap: 2px;
                height: 20px;
            }
            .typing-indicator span {
                height: 8px;
                width: 8px;
                background-color: currentColor;
                border-radius: 50%;
                display: inline-block;
                animation: typing 1.4s infinite ease-in-out both;
            }
            .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
            .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
            @keyframes typing {
                0%, 80%, 100% { transform: scale(0); }
                40% { transform: scale(1); }
            }
            .pulse-dot {
                position: relative;
            }
            .pulse-dot::after {
                content: '';
                position: absolute;
                width: 8px;
                height: 8px;
                background-color: theme('colors.secondary');
                border-radius: 50%;
                top: -1px;
                right: -1px;
                box-shadow: 0 0 0 rgba(16, 185, 129, 0.7);
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
                100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
            }
            .image-preview-enter {
                animation: imagePreviewEnter 0.4s ease-out forwards;
                opacity: 0;
                transform: scale(0.95);
            }
            @keyframes imagePreviewEnter {
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
        }
    </style>
</head>
<body class="font-inter bg-light-100 text-gray-800 dark:bg-dark-300 dark:text-light-100 transition-colors duration-300 min-h-screen flex flex-col">
    <!-- 顶部导航 -->
    <header class="sticky top-0 z-50 bg-white/80 dark:bg-dark-300/80 backdrop-blur-md border-b border-light-300 dark:border-dark-100 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-light-200 dark:hover:bg-dark-200 transition-colors">
                    <i class="fa fa-moon-o dark:hidden text-gray-600"></i>
                    <i class="fa fa-sun-o hidden dark:block text-yellow-300"></i>
                </button>
                <a href="/" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center">
                        <i class="fa fa-comments text-white"></i>
                    </div>
                    <span class="font-bold text-lg hidden sm:inline-block">ChatSync</span>
                </a>
            </div>
            
            <div class="flex items-center gap-4">
                <button id="share-btn" class="p-2 rounded-full hover:bg-light-200 dark:hover:bg-dark-200 transition-colors relative">
                    <i class="fa fa-share-alt text-gray-600 dark:text-light-300"></i>
                    <span class="absolute -top-1 -right-1 w-4 h-4 bg-accent text-white text-xs rounded-full flex items-center justify-center">
                        <i class="fa fa-share"></i>
                    </span>
                </button>
                <button id="bookmarkBtn" class="p-2 rounded-full hover:bg-light-200 dark:hover:bg-dark-200 transition-colors">
                    <i class="fa fa-bookmark-o text-gray-600 dark:text-light-300"></i>
                </button>
            </div>
        </div>
        
        <!-- 面包屑导航 -->
        <div class="container mx-auto px-4 py-2 text-sm text-gray-500 dark:text-gray-400 border-t border-light-300 dark:border-dark-100">
            <nav class="flex items-center gap-2">
                <a href="/" class="hover:text-primary dark:hover:text-primary transition-colors">首页</a>
                <i class="fa fa-angle-right text-xs"></i>
                <a href="/free" class="hover:text-primary dark:hover:text-primary transition-colors">资源分类</a>
                <i class="fa fa-angle-right text-xs"></i>
                <a href="/free/detail/" class="hover:text-primary dark:hover:text-primary transition-colors">资源列表</a>
                <i class="fa fa-angle-right text-xs"></i>
                <span class="text-primary">高级多人实时聊天</span>
            </nav>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-1 container mx-auto px-4 py-6 md:py-8">
        <div class="max-w-6xl mx-auto bg-white dark:bg-dark-200 rounded-2xl shadow-lg overflow-hidden transition-all duration-300 transform hover:shadow-xl">
            <!-- 聊天头部 -->
            <div class="bg-gradient-to-r from-primary to-accent p-4 md:p-6 text-white">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-[clamp(1.5rem,3vw,2.2rem)] font-bold text-shadow">
                            多人实时聊天
                        </h1>
                        <p class="text-blue-100/90 mt-1 max-w-xl">
                            支持文本、语音和图片消息，实时查看在线状态和输入提示
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="hidden md:flex items-center gap-2 bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-full">
                            <div class="w-3 h-3 bg-secondary rounded-full animate-pulse"></div>
                            <span id="active-users-count" class="text-sm font-medium">0 人在线</span>
                        </div>
                        <button id="voice-toggle" class="bg-white/20 backdrop-blur-sm hover:bg-white/30 p-3 rounded-full transition-all transform hover:scale-105">
                            <i class="fa fa-microphone-slash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row h-[calc(100vh-280px)] min-h-[500px]">
                <!-- 在线用户区域 -->
                <div class="w-full lg:w-72 bg-light-100 dark:bg-dark-300 border-b lg:border-b-0 lg:border-r border-light-300 dark:border-dark-100 transition-colors">
                    <div class="p-4 border-b border-light-300 dark:border-dark-100">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-users text-primary mr-2"></i>在线用户
                            <span id="user-count" class="ml-2 bg-primary/10 text-primary text-xs px-2 py-0.5 rounded-full">0</span>
                        </h2>
                    </div>
                    <div id="online-users" class="p-3 space-y-1.5 max-h-full overflow-y-auto scrollbar-thumb-rounded">
                        <!-- 在线用户会通过JavaScript动态添加 -->
                    </div>
                </div>

                <!-- 聊天区域 -->
                <div class="flex-1 flex flex-col">
                    <!-- 消息列表 -->
                    <div id="messages" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-5 bg-gradient-messenger scrollbar-thumb-rounded">
                        <div class="text-center text-gray-500 dark:text-gray-400 text-sm animate-fade-in">
                            欢迎加入聊天！你的昵称是：<span id="current-username" class="font-semibold text-primary"></span>
                        </div>
                        <!-- 正在输入提示 -->
                        <div id="typing-indicator" class="hidden pl-12 animate-fade-in">
                            <div class="inline-flex items-center gap-2 bg-light-200 dark:bg-dark-100 px-3 py-1.5 rounded-full text-sm text-gray-600 dark:text-gray-300">
                                <span id="typing-username"></span>
                                <span class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </span>
                            </div>
                        </div>
                        <!-- 消息会通过JavaScript动态添加 -->
                    </div>

                    <!-- 输入区域 -->
                    <div class="p-4 border-t border-light-300 dark:border-dark-100 bg-white dark:bg-dark-200 transition-colors">
                        <!-- 输入工具栏 -->
                        <div class="flex items-center gap-3 mb-3">
                            <label for="image-upload" class="p-2 rounded-full hover:bg-light-200 dark:hover:bg-dark-100 transition-colors cursor-pointer text-gray-600 dark:text-gray-300">
                                <i class="fa fa-image"></i>
                            </label>
                            <input type="file" id="image-upload" accept="image/*" class="hidden">
                            <button id="voice-record" class="p-2 rounded-full hover:bg-light-200 dark:hover:bg-dark-100 transition-colors text-gray-600 dark:text-gray-300">
                                <i class="fa fa-microphone"></i>
                            </button>
                            <div class="flex-1 h-[1px] bg-light-300 dark:bg-dark-100"></div>
                        </div>
                        
                        <!-- 图片预览 -->
                        <div id="image-preview-container" class="mb-3 hidden">
                            <div class="relative rounded-lg overflow-hidden border border-light-300 dark:border-dark-100">
                                <img id="image-preview" src="" alt="预览图片" class="w-full max-h-48 object-contain image-preview-enter">
                                <button id="cancel-image" class="absolute top-2 right-2 bg-black/50 text-white p-1.5 rounded-full hover:bg-black/70 transition-colors">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 主输入区域 -->
                        <div class="flex items-center gap-3">
                            <textarea id="message-input" placeholder="输入消息..." 
                                class="flex-1 px-4 py-3 rounded-xl border border-light-300 dark:border-dark-100 bg-light-100 dark:bg-dark-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none transition-all min-h-[50px] max-h-[150px] overflow-y-auto scrollbar-thumb-rounded"></textarea>
                            <button id="send-message" class="bg-primary hover:bg-primary/90 text-white p-3 rounded-full transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 收藏列表 -->
    <div id="bookmarkList" class="fixed top-20 right-4 w-72 bg-white dark:bg-dark-200 rounded-xl shadow-xl border border-light-300 dark:border-dark-100 p-4 z-40 hidden animate-slide-up">
        <h3 class="font-semibold text-lg mb-3 flex items-center">
            <i class="fa fa-bookmark text-accent mr-2"></i>我的收藏
        </h3>
        <div class="space-y-2 max-h-60 overflow-y-auto scrollbar-thumb-rounded">
            <!-- 收藏内容将通过/main.js动态填充 -->
            <div class="text-gray-500 dark:text-gray-400 text-sm italic text-center py-6">
                收藏列表为空
            </div>
        </div>
    </div>

    <!-- 分享弹窗 -->
    <div id="share-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center hidden animate-fade-in">
        <div class="bg-white dark:bg-dark-200 rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl">分享聊天</h3>
                <button id="close-share" class="p-2 hover:bg-light-200 dark:hover:bg-dark-100 rounded-full transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <p class="text-gray-600 dark:text-gray-300 mb-5">
                邀请好友加入当前聊天
            </p>
            <div class="flex gap-3 mb-5">
                <button class="flex-1 py-3 rounded-xl bg-[#1877F2] text-white hover:bg-[#1877F2]/90 transition-colors">
                    <i class="fa fa-facebook mr-2"></i>Facebook
                </button>
                <button class="flex-1 py-3 rounded-xl bg-[#1DA1F2] text-white hover:bg-[#1DA1F2]/90 transition-colors">
                    <i class="fa fa-twitter mr-2"></i>Twitter
                </button>
            </div>
            <div class="flex gap-3 mb-5">
                <button class="flex-1 py-3 rounded-xl bg-[#25D366] text-white hover:bg-[#25D366]/90 transition-colors">
                    <i class="fa fa-whatsapp mr-2"></i>WhatsApp
                </button>
                <button class="flex-1 py-3 rounded-xl bg-gray-800 text-white hover:bg-gray-700 transition-colors">
                    <i class="fa fa-link mr-2"></i>复制链接
                </button>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-white dark:bg-dark-200 border-t border-light-300 dark:border-dark-100 py-6 transition-colors">
        <div class="container mx-auto px-4">
            <div class="max-w-6xl mx-auto">
                <!-- 邮件订阅 -->
                <div class="mb-8 p-4 bg-light-100 dark:bg-dark-300 rounded-xl">
                    <h3 class="font-bold text-lg mb-3">订阅最新功能更新</h3>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="email" id="subscribeEmail" placeholder="输入您的邮箱地址" 
                            class="flex-1 px-4 py-3 rounded-lg border border-light-300 dark:border-dark-100 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
                        <button id="subscribeBtn" class="bg-accent hover:bg-accent/90 text-white px-6 py-3 rounded-lg transition-all transform hover:scale-105">
                            订阅
                        </button>
                    </div>
                    <p id="subscriptionMessage" class="mt-2 text-sm text-gray-500 dark:text-gray-400 hidden"></p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <h4 class="font-bold text-lg mb-4 flex items-center">
                            <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-primary to-accent flex items-center justify-center mr-2">
                                <i class="fa fa-comments text-white text-xs"></i>
                            </div>
                            ChatSync
                        </h4>
                        <p class="text-gray-600 dark:text-gray-300 text-sm mb-4">
                            提供高品质的实时通讯体验，让交流更加便捷高效。
                        </p>
                        <div class="flex gap-3">
                            <a href="#" class="p-2 bg-light-200 dark:bg-dark-100 rounded-full hover:bg-primary hover:text-white transition-all">
                                <i class="fa fa-twitter"></i>
                            </a>
                            <a href="#" class="p-2 bg-light-200 dark:bg-dark-100 rounded-full hover:bg-primary hover:text-white transition-all">
                                <i class="fa fa-facebook"></i>
                            </a>
                            <a href="#" class="p-2 bg-light-200 dark:bg-dark-100 rounded-full hover:bg-primary hover:text-white transition-all">
                                <i class="fa fa-instagram"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-lg mb-4">快速链接</h4>
                        <ul class="space-y-2 text-gray-600 dark:text-gray-300">
                            <li><a href="/" class="hover:text-primary transition-colors">首页</a></li>
                            <li><a href="/free" class="hover:text-primary transition-colors">资源分类</a></li>
                            <li><a href="/free/detail/" class="hover:text-primary transition-colors">资源列表</a></li>
                            <li><a href="/about" class="hover:text-primary transition-colors">关于我们</a></li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-lg mb-4">法律信息</h4>
                        <ul class="space-y-2 text-gray-600 dark:text-gray-300">
                            <li><a href="/privacy" class="hover:text-primary transition-colors">隐私政策</a></li>
                            <li><a href="/terms" class="hover:text-primary transition-colors">使用条款</a></li>
                            <li><a href="/sitemap.html" class="hover:text-primary transition-colors">网站地图</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="border-t border-light-300 dark:border-dark-100 mt-8 pt-6 text-center text-gray-500 dark:text-gray-400 text-sm">
                    &copy; 2023 ChatSync. 保留所有权利。
                </div>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <!-- 引入已实现的收藏和订阅功能 -->
    <script type="module" src="/main.js"></script>

    <script>
        // 初始化Firebase - 使用你的配置信息
        const firebaseConfig = {
            apiKey: "AIzaSyD19ZwRmby0LATLuswJvqaiRcRbEGrtElg",
            authDomain: "rinuo-a2679.firebaseapp.com",
            databaseURL: "https://rinuo-a2679-default-rtdb.firebaseio.com",
            projectId: "rinuo-a2679",
            storageBucket: "rinuo-a2679.firebasestorage.app",
            messagingSenderId: "818845165575",
            appId: "1:818845165575:web:f35118e617e1138098a2a2",
            measurementId: "G-MWP5DF8H47"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const messagesRef = database.ref('messages');
        const usersRef = database.ref('users');
        const typingRef = database.ref('typing');
        
        // 生成随机用户ID
        const userId = 'user_' + Math.random().toString(36).substring(2, 10);
        
        // 随机昵称生成器
        const adjectives = ['快乐的', '聪明的', '勇敢的', '机智的', '温柔的', '活泼的', '冷静的', '热情的', '幽默的', '善良的', '好奇的', '友善的', '专注的', '创意的', '阳光的'];
        const nouns = ['小猫', '老虎', '兔子', '狐狸', '小熊', '小鸟', '小鱼', '松鼠', '熊猫', '海豚', '猎豹', '野狼', '蜜蜂', '蝴蝶', '雄鹰'];
        
        function generateRandomName() {
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            return adj + noun;
        }
        
        // 当前用户信息
        let currentUser = {
            id: userId,
            name: generateRandomName(),
            online: true,
            lastActive: new Date().getTime(),
            isTyping: false
        };

        // DOM元素
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message');
        const onlineUsersContainer = document.getElementById('online-users');
        const userCountElement = document.getElementById('user-count');
        const activeUsersCountElement = document.getElementById('active-users-count');
        const currentUsernameElement = document.getElementById('current-username');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingUsernameElement = document.getElementById('typing-username');
        const themeToggle = document.getElementById('theme-toggle');
        const voiceToggle = document.getElementById('voice-toggle');
        const voiceRecordBtn = document.getElementById('voice-record');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const cancelImageBtn = document.getElementById('cancel-image');
        const shareBtn = document.getElementById('share-btn');
        const shareModal = document.getElementById('share-modal');
        const closeShareBtn = document.getElementById('close-share');
        
        // 图片上传相关
        let selectedImage = null;
        
        // 初始化
        function init() {
            // 检查用户偏好的主题模式
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // 显示当前用户名
            currentUsernameElement.textContent = currentUser.name;
            
            // 将当前用户添加到在线用户列表
            const userRef = usersRef.child(currentUser.id);
            userRef.set(currentUser);
            
            // 设置用户断开连接时的处理
            userRef.onDisconnect().update({
                online: false,
                lastActive: new Date().getTime()
            });
            
            // 监听窗口关闭事件
            window.addEventListener('beforeunload', () => {
                userRef.update({
                    online: false,
                    lastActive: new Date().getTime()
                });
            });
            
            // 监听用户连接状态变化
            usersRef.on('value', snapshot => {
                updateOnlineUsers(snapshot.val());
            });
            
            // 监听正在输入状态
            typingRef.on('value', snapshot => {
                const typingUsers = snapshot.val();
                updateTypingIndicator(typingUsers);
            });
            
            // 当用户开始/停止输入时更新状态
            messageInput.addEventListener('input', handleTyping);
            
            // 设置输入超时，一段时间不输入后清除正在输入状态
            let typingTimeout;
            function handleTyping() {
                const isTyping = messageInput.value.trim().length > 0;
                
                if (isTyping && !currentUser.isTyping) {
                    currentUser.isTyping = true;
                    typingRef.child(currentUser.id).set({
                        username: currentUser.name,
                        timestamp: new Date().getTime()
                    });
                    
                    // 清除之前的超时
                    clearTimeout(typingTimeout);
                    
                    // 5秒后如果没有继续输入，清除正在输入状态
                    typingTimeout = setTimeout(() => {
                        if (currentUser.isTyping) {
                            currentUser.isTyping = false;
                            typingRef.child(currentUser.id).remove();
                        }
                    }, 5000);
                } else if (!isTyping && currentUser.isTyping) {
                    currentUser.isTyping = false;
                    typingRef.child(currentUser.id).remove();
                    clearTimeout(typingTimeout);
                }
            }
            
            // 加载历史消息
            loadMessages();
            
            // 监听新消息
            listenForNewMessages();
            
            // 处理图片上传预览
            imageUpload.addEventListener('change', handleImageUpload);
            cancelImageBtn.addEventListener('click', cancelImage);
            
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 语音聊天切换
            voiceToggle.addEventListener('click', toggleVoice);
            
            // 分享功能
            shareBtn.addEventListener('click', () => shareModal.classList.remove('hidden'));
            closeShareBtn.addEventListener('click', () => shareModal.classList.add('hidden'));
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    shareModal.classList.add('hidden');
                }
            });
        }

        // 更新在线用户列表
        function updateOnlineUsers(users) {
            onlineUsersContainer.innerHTML = '';
            
            if (!users) {
                userCountElement.textContent = '0';
                activeUsersCountElement.textContent = '0 人在线';
                return;
            }
            
            const userList = Object.values(users);
            const onlineUsers = userList.filter(user => user.online);
            
            userCountElement.textContent = onlineUsers.length;
            activeUsersCountElement.textContent = `${onlineUsers.length} 人在线`;
            
            // 按用户名排序
            onlineUsers.sort((a, b) => a.name.localeCompare(b.name))
                   .forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `flex items-center gap-3 p-2 rounded-lg cursor-pointer transition-all ${user.id === currentUser.id ? 'bg-primary/10' : 'hover:bg-light-200 dark:hover:bg-dark-100'}`;
                
                // 用户头像（简单的字母缩写）
                const avatar = document.createElement('div');
                const initials = user.name.charAt(0);
                const avatarColors = [
                    'bg-primary', 'bg-secondary', 'bg-accent', 
                    'bg-pink-500', 'bg-orange-500', 'bg-emerald-500',
                    'bg-amber-500', 'bg-rose-500', 'bg-violet-500'
                ];
                // 根据用户ID哈希选择一个固定颜色
                const colorIndex = Math.abs(hashCode(user.id)) % avatarColors.length;
                const avatarColor = avatarColors[colorIndex];
                
                avatar.className = `w-9 h-9 rounded-full ${avatarColor} text-white flex items-center justify-center font-bold relative`;
                avatar.textContent = initials;
                
                // 在线状态指示器
                if (user.online) {
                    avatar.classList.add('pulse-dot');
                }
                
                // 用户名和状态
                const userInfo = document.createElement('div');
                userInfo.className = 'flex-1 min-w-0';
                
                const username = document.createElement('div');
                username.className = `text-sm font-medium truncate ${user.id === currentUser.id ? 'text-primary' : ''}`;
                username.textContent = user.name;
                if (user.id === currentUser.id) {
                    const youLabel = document.createElement('span');
                    youLabel.className = 'ml-2 text-xs bg-primary/20 text-primary px-1.5 py-0.5 rounded';
                    youLabel.textContent = '你';
                    username.appendChild(youLabel);
                }
                
                // 正在输入状态
                const status = document.createElement('div');
                status.className = 'text-xs text-gray-500 dark:text-gray-400';
                
                if (user.isTyping) {
                    status.innerHTML = '<i class="fa fa-pencil mr-1"></i>正在输入...';
                } else {
                    status.textContent = '在线';
                }
                
                userInfo.appendChild(username);
                userInfo.appendChild(status);
                
                userElement.appendChild(avatar);
                userElement.appendChild(userInfo);
                onlineUsersContainer.appendChild(userElement);
                
                // 添加动画效果
                userElement.classList.add('animate-fade-in');
            });
        }
        
        // 更新正在输入指示器
        function updateTypingIndicator(typingUsers) {
            if (!typingUsers) {
                typingIndicator.classList.add('hidden');
                return;
            }
            
            const typingUserIds = Object.keys(typingUsers);
            // 排除当前用户自己
            const otherTypingUsers = typingUserIds.filter(id => id !== currentUser.id)
                .map(id => typingUsers[id]);
            
            if (otherTypingUsers.length > 0) {
                // 显示第一个正在输入的用户
                typingUsernameElement.textContent = otherTypingUsers[0].username;
                typingIndicator.classList.remove('hidden');
                
                // 如果有多个用户正在输入
                if (otherTypingUsers.length > 1) {
                    typingUsernameElement.textContent += ` 等${otherTypingUsers.length}人`;
                }
            } else {
                typingIndicator.classList.add('hidden');
            }
        }

        // 发送消息
        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 发送消息函数
        function sendMessage() {
            const text = messageInput.value.trim();
            const hasContent = text.length > 0 || selectedImage;
            
            if (hasContent) {
                // 创建消息对象
                const message = {
                    userId: currentUser.id,
                    username: currentUser.name,
                    text: text,
                    image: selectedImage || null,
                    type: selectedImage ? 'image' : 'text',
                    timestamp: new Date().getTime()
                };

                // 保存到Firebase数据库
                messagesRef.push(message)
                    .then(() => {
                        // 清空输入框和图片预览
                        messageInput.value = '';
                        cancelImage();
                        
                        // 清除正在输入状态
                        if (currentUser.isTyping) {
                            currentUser.isTyping = false;
                            typingRef.child(currentUser.id).remove();
                        }
                        
                        // 更新最后活跃时间
                        usersRef.child(currentUser.id).update({
                            lastActive: new Date().getTime()
                        });
                    })
                    .catch((error) => {
                        console.error('发送消息失败:', error);
                        alert('发送消息失败，请重试');
                    });
            }
        }

        // 处理图片上传
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    selectedImage = event.target.result;
                    imagePreview.src = selectedImage;
                    imagePreviewContainer.classList.remove('hidden');
                    // 确保图片正确加载
                    imagePreview.onload = function() {
                        imagePreview.classList.add('image-preview-enter');
                    }
                };
                
                reader.readAsDataURL(file);
            }
            
            // 重置input，允许重复选择同一张图片
            imageUpload.value = '';
        }
        
        // 取消图片上传
        function cancelImage() {
            selectedImage = null;
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
            imagePreview.classList.remove('image-preview-enter');
        }

        // 加载历史消息
        function loadMessages() {
            // 只加载最近的50条消息
            messagesRef.limitToLast(50).once('value')
                .then((snapshot) => {
                    const messages = snapshot.val();
                    if (messages) {
                        Object.values(messages).forEach(addMessageToDOM);
                    }
                    scrollToBottom();
                })
                .catch((error) => {
                    console.error('加载消息失败:', error);
                });
        }

        // 监听新消息
        function listenForNewMessages() {
            // 监听新添加的消息
            messagesRef.limitToLast(1).on('child_added', (snapshot) => {
                const message = snapshot.val();
                // 检查是否已经添加过这条消息
                const messageExists = document.querySelector(`[data-message-id="${snapshot.key}"]`);
                if (!messageExists) {
                    addMessageToDOM(message, snapshot.key);
                    scrollToBottom();
                    
                    // 播放通知声音（如果不在当前标签页）
                    if (!document.hasFocus() && message.userId !== currentUser.id) {
                        playNotificationSound();
                    }
                }
            });
        }

        // 添加消息到DOM
        function addMessageToDOM(message, messageId) {
            const messageElement = document.createElement('div');
            messageElement.className = `animate-fade-in ${message.userId === currentUser.id ? 'flex justify-end' : 'flex justify-start'}`;
            messageElement.dataset.messageId = messageId || message.timestamp;
            
            const messageContent = document.createElement('div');
            const isCurrentUser = message.userId === currentUser.id;
            const maxWidth = 'max-w-[85%] sm:max-w-[70%]';
            
            if (message.type === 'text') {
                messageContent.className = `${maxWidth} px-4 py-3 rounded-2xl ${
                    isCurrentUser 
                        ? 'bg-primary text-white rounded-tr-none' 
                        : 'bg-light-200 dark:bg-dark-100 rounded-tl-none'
                }`;
                
                // 用户名和时间
                const header = document.createElement('div');
                header.className = `text-xs mb-1 ${isCurrentUser ? 'text-blue-100' : 'text-gray-500 dark:text-gray-400'}`;
                
                const date = new Date(message.timestamp);
                const timeString = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                header.textContent = `${message.username} · ${timeString}`;
                
                // 消息内容
                const content = document.createElement('div');
                content.textContent = message.text;
                
                messageContent.appendChild(header);
                messageContent.appendChild(content);
            } else if (message.type === 'image') {
                messageContent.className = `${maxWidth} rounded-2xl overflow-hidden border ${
                    isCurrentUser 
                        ? 'border-primary/30' 
                        : 'border-light-300 dark:border-dark-100'
                }`;
                
                // 图片容器
                const imageContainer = document.createElement('div');
                imageContainer.className = 'relative';
                
                // 图片
                const image = document.createElement('img');
                image.src = message.image;
                image.alt = `${message.username}发送的图片`;
                image.className = 'w-full h-auto object-contain lazy-load';
                image.loading = 'lazy';
                
                // 图片下方信息
                const imageInfo = document.createElement('div');
                imageInfo.className = `px-3 py-2 text-xs ${isCurrentUser ? 'bg-primary/90 text-white' : 'bg-light-200 dark:bg-dark-100 text-gray-500 dark:text-gray-400'}`;
                
                const date = new Date(message.timestamp);
                const timeString = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                imageInfo.textContent = `${message.username} · ${timeString} · 图片`;
                
                imageContainer.appendChild(image);
                messageContent.appendChild(imageContainer);
                messageContent.appendChild(imageInfo);
            }
            
            messageElement.appendChild(messageContent);
            
            // 确保正在输入指示器在消息上方
            const typingIndicatorElement = document.getElementById('typing-indicator');
            if (typingIndicatorElement && !typingIndicatorElement.classList.contains('hidden')) {
                messagesContainer.insertBefore(messageElement, typingIndicatorElement);
            } else {
                messagesContainer.appendChild(messageElement);
            }
        }

        // 滚动到底部
        function scrollToBottom() {
            // 只有当用户接近底部时才自动滚动
            const scrollThreshold = 100;
            if (messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < scrollThreshold) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        // 播放通知声音
        function playNotificationSound() {
            // 检查浏览器是否支持通知
            if (Notification.permission === 'granted') {
                new Notification('新消息', {
                    body: '有人发送了新消息',
                    icon: '/favicon.ico'
                });
            } else if (Notification.permission !== 'denied') {
                // 请求通知权限
                Notification.requestPermission();
            }
        }
        
        // 切换主题
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
        
        // 切换语音聊天
        function toggleVoice() {
            const icon = voiceToggle.querySelector('i');
            if (icon.classList.contains('fa-microphone-slash')) {
                icon.classList.remove('fa-microphone-slash');
                icon.classList.add('fa-microphone');
                voiceToggle.classList.add('bg-secondary');
                showToast('语音聊天已开启');
            } else {
                icon.classList.remove('fa-microphone');
                icon.classList.add('fa-microphone-slash');
                voiceToggle.classList.remove('bg-secondary');
                showToast('语音聊天已关闭');
            }
        }
        
        // 显示提示消息
        function showToast(message) {
            // 检查是否已有toast
            let toast = document.querySelector('.toast-notification');
            if (!toast) {
                toast = document.createElement('div');
                toast.className = 'toast-notification fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-dark-300 dark:bg-dark-100 text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300';
                document.body.appendChild(toast);
            }
            
            toast.textContent = message;
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }
        
        // 简单的哈希函数，用于生成头像颜色
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 转换为32位整数
            }
            return hash;
        }

        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>
