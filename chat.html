<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 多人聊天</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // 配置Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',
                        secondary: '#3b82f6',
                        dark: '#0f172a',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .pulse-dot {
                position: relative;
            }
            .pulse-dot::after {
                content: '';
                position: absolute;
                width: 8px;
                height: 8px;
                background-color: #10b981;
                border-radius: 50%;
                top: -2px;
                right: -2px;
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
                70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
                100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- 聊天头部 -->
            <div class="bg-primary text-white p-4">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fa fa-comments-o mr-2"></i>Firebase 多人聊天
                </h1>
                <p class="text-blue-100 text-sm mt-1">实时多人聊天演示 - 自动分配昵称</p>
            </div>

            <div class="flex flex-col md:flex-row">
                <!-- 在线用户区域 -->
                <div class="w-full md:w-64 bg-gray-50 border-r p-4">
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <i class="fa fa-users text-primary mr-2"></i>在线用户
                        <span id="user-count" class="ml-2 bg-primary/10 text-primary text-xs px-2 py-1 rounded-full"></span>
                    </h2>
                    <div id="online-users" class="space-y-2 max-h-[580px] overflow-y-auto scrollbar-hide">
                        <!-- 在线用户会通过JavaScript动态添加 -->
                    </div>
                </div>

                <!-- 聊天区域 -->
                <div class="flex-1">
                    <!-- 消息列表 -->
                    <div id="messages" class="h-[500px] overflow-y-auto p-4 space-y-4 scrollbar-hide">
                        <div class="text-center text-gray-500 text-sm">
                            欢迎加入聊天！你的昵称是：<span id="current-username" class="font-semibold text-primary"></span>
                        </div>
                        <!-- 消息会通过JavaScript动态添加 -->
                    </div>

                    <!-- 输入区域 -->
                    <div class="p-4 border-t flex items-center gap-2">
                        <input type="text" id="message-input" placeholder="输入消息..." 
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                        <button id="send-message" class="bg-secondary hover:bg-secondary/90 text-white p-3 rounded-lg transition-all transform hover:scale-105">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // 初始化Firebase - 使用你的配置信息
        const firebaseConfig = {
            apiKey: "AIzaSyD19ZwRmby0LATLuswJvqaiRcRbEGrtElg",
            authDomain: "rinuo-a2679.firebaseapp.com",
            databaseURL: "https://rinuo-a2679-default-rtdb.firebaseio.com",
            projectId: "rinuo-a2679",
            storageBucket: "rinuo-a2679.firebasestorage.app",
            messagingSenderId: "818845165575",
            appId: "1:818845165575:web:f35118e617e1138098a2a2",
            measurementId: "G-MWP5DF8H47"
        };

        // 初始化Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const messagesRef = database.ref('messages');
        const usersRef = database.ref('users');
        
        // 生成随机用户ID
        const userId = 'user_' + Math.random().toString(36).substring(2, 10);
        
        // 随机昵称生成器
        const adjectives = ['快乐的', '聪明的', '勇敢的', '机智的', '温柔的', '活泼的', '冷静的', '热情的', '幽默的', '善良的'];
        const nouns = ['小猫', '老虎', '兔子', '狐狸', '小熊', '小鸟', '小鱼', '松鼠', '熊猫', '海豚'];
        
        function generateRandomName() {
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            return adj + noun;
        }
        
        // 当前用户信息
        let currentUser = {
            id: userId,
            name: generateRandomName(),
            online: true,
            lastActive: new Date().getTime()
        };

        // DOM元素
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageBtn = document.getElementById('send-message');
        const onlineUsersContainer = document.getElementById('online-users');
        const userCountElement = document.getElementById('user-count');
        const currentUsernameElement = document.getElementById('current-username');

        // 初始化
        function init() {
            // 显示当前用户名
            currentUsernameElement.textContent = currentUser.name;
            
            // 将当前用户添加到在线用户列表
            const userRef = usersRef.child(currentUser.id);
            userRef.set(currentUser);
            
            // 设置用户断开连接时的处理
            userRef.onDisconnect().remove();
            
            // 监听用户连接状态变化
            usersRef.on('value', snapshot => {
                updateOnlineUsers(snapshot.val());
            });
            
            // 加载历史消息
            loadMessages();
            
            // 监听新消息
            listenForNewMessages();
        }

        // 更新在线用户列表
        function updateOnlineUsers(users) {
            onlineUsersContainer.innerHTML = '';
            
            if (!users) {
                userCountElement.textContent = '0';
                return;
            }
            
            const userList = Object.values(users);
            userCountElement.textContent = userList.length;
            
            // 按用户名排序
            userList.sort((a, b) => a.name.localeCompare(b.name))
                   .forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `flex items-center gap-2 p-2 rounded-lg ${user.id === currentUser.id ? 'bg-primary/10' : 'hover:bg-gray-100'}`;
                
                // 用户头像（简单的字母缩写）
                const avatar = document.createElement('div');
                const initials = user.name.charAt(0);
                avatar.className = `w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm relative pulse-dot`;
                avatar.textContent = initials;
                
                // 用户名
                const username = document.createElement('div');
                username.className = `text-sm font-medium ${user.id === currentUser.id ? 'text-primary' : ''}`;
                username.textContent = user.name;
                if (user.id === currentUser.id) {
                    const youLabel = document.createElement('span');
                    youLabel.className = 'ml-2 text-xs bg-primary/20 text-primary px-1.5 py-0.5 rounded';
                    youLabel.textContent = '你';
                    username.appendChild(youLabel);
                }
                
                userElement.appendChild(avatar);
                userElement.appendChild(username);
                onlineUsersContainer.appendChild(userElement);
            });
        }

        // 发送消息
        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 发送消息函数
        function sendMessage() {
            const text = messageInput.value.trim();
            if (text) {
                // 创建消息对象
                const message = {
                    userId: currentUser.id,
                    username: currentUser.name,
                    text: text,
                    timestamp: new Date().getTime()
                };

                // 保存到Firebase数据库
                messagesRef.push(message)
                    .then(() => {
                        // 清空输入框
                        messageInput.value = '';
                        // 更新最后活跃时间
                        usersRef.child(currentUser.id).update({
                            lastActive: new Date().getTime()
                        });
                    })
                    .catch((error) => {
                        console.error('发送消息失败:', error);
                        alert('发送消息失败，请重试');
                    });
            }
        }

        // 加载历史消息
        function loadMessages() {
            // 只加载最近的50条消息
            messagesRef.limitToLast(50).once('value')
                .then((snapshot) => {
                    const messages = snapshot.val();
                    if (messages) {
                        Object.values(messages).forEach(addMessageToDOM);
                    }
                    scrollToBottom();
                })
                .catch((error) => {
                    console.error('加载消息失败:', error);
                });
        }

        // 监听新消息
        function listenForNewMessages() {
            // 只监听新添加的消息
            messagesRef.limitToLast(1).on('child_added', (snapshot) => {
                const message = snapshot.val();
                addMessageToDOM(message);
                scrollToBottom();
            });
        }

        // 添加消息到DOM
        function addMessageToDOM(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `flex ${message.userId === currentUser.id ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            const isCurrentUser = message.userId === currentUser.id;
            
            messageBubble.className = `max-w-[80%] px-4 py-3 rounded-lg ${
                isCurrentUser 
                    ? 'bg-primary text-white rounded-tr-none' 
                    : 'bg-gray-200 text-gray-800 rounded-tl-none'
            }`;
            
            // 用户名和时间
            const header = document.createElement('div');
            header.className = `text-xs mb-1 ${isCurrentUser ? 'text-blue-100' : 'text-gray-500'}`;
            
            const date = new Date(message.timestamp);
            const timeString = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            
            header.textContent = `${message.username} · ${timeString}`;
            
            // 消息内容
            const content = document.createElement('div');
            content.textContent = message.text;
            
            messageBubble.appendChild(header);
            messageBubble.appendChild(content);
            messageElement.appendChild(messageBubble);
            
            messagesContainer.appendChild(messageElement);
        }

        // 滚动到底部
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
  <script type="module" src="/main.js"></script>
</body>
</html>
