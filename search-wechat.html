<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>搜索框演示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1677ff',
                        secondary: '#f0f2f5',
                        darkSecondary: '#2d2d2d',
                        neutral: '#8c8c8c',
                        darkText: '#e0e0e0',
                        darkBg: '#1a1a1a',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .search-shadow {
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .dark-search-shadow {
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }
            .result-item-hover {
                @apply bg-secondary dark:bg-darkSecondary transition-colors duration-200;
            }
            .mode-transition {
                transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-darkBg font-sans mode-transition">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-gray-800 dark:text-white mode-transition">搜索演示</h1>
            <!-- 昼夜模式切换按钮 -->
            <button id="themeToggle" class="p-2 rounded-full bg-secondary dark:bg-darkSecondary text-gray-600 dark:text-darkText mode-transition">
                <i class="fa fa-moon-o" id="themeIcon"></i>
            </button>
        </div>
        
        <!-- 搜索容器 -->
        <div class="relative">
            <!-- 搜索框 -->
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="输入关键词搜索..." 
                    class="w-full py-3 px-4 pr-10 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all duration-200 search-shadow dark:dark-search-shadow mode-transition"
                >
                <button id="clearBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-neutral opacity-0 transition-opacity duration-200">
                    <i class="fa fa-times-circle text-lg"></i>
                </button>
                <button id="searchBtn" class="absolute right-10 top-1/2 transform -translate-y-1/2 text-primary">
                    <i class="fa fa-search text-lg"></i>
                </button>
            </div>
            
            <!-- 搜索结果容器 - 初始隐藏 -->
            <div id="searchResults" class="absolute left-0 right-0 mt-1 bg-white dark:bg-gray-800 rounded-lg shadow-lg dark:shadow-black/30 overflow-hidden z-50 max-h-80 overflow-y-auto hidden mode-transition">
                <!-- 加载状态 - 初始隐藏 -->
                <div id="loadingIndicator" class="p-4 flex items-center justify-center hidden">
                    <i class="fa fa-spinner fa-spin text-primary mr-2"></i>
                    <span class="text-gray-600 dark:text-darkText mode-transition">搜索中...</span>
                </div>
                
                <!-- 无结果状态 - 初始隐藏 -->
                <div id="noResults" class="p-4 text-center text-gray-500 dark:text-darkText mode-transition hidden">
                    <i class="fa fa-search-minus text-2xl mb-2 block"></i>
                    <span>没有找到匹配的结果</span>
                </div>
                
                <!-- 结果列表 -->
                <ul id="resultsList" class="divide-y divide-gray-100 dark:divide-gray-700">
                    <!-- 结果将通过JS动态插入 -->
                </ul>
            </div>
        </div>
        
        <div class="mt-8 text-center text-sm text-gray-500 dark:text-gray-400 mode-transition">
            <p>尝试搜索: React、Vue、JavaScript、Python、Docker</p>
        </div>
    </div>

    <script>
        // DOM元素
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearBtn');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const resultsList = document.getElementById('resultsList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noResults = document.getElementById('noResults');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');

        // 存储从data.json加载的数据
        let toolsData = [];
        
        // 加载数据的状态
        let isDataLoaded = false;
        let isLoading = false;

        // 检查本地存储中的主题偏好
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        updateTheme();

        // 监听输入事件
        searchInput.addEventListener('input', handleInput);
        // 监听清除按钮点击
        clearBtn.addEventListener('click', clearSearch);
        // 监听搜索按钮点击
        searchBtn.addEventListener('click', performSearch);
        // 监听键盘事件
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // 监听主题切换按钮
        themeToggle.addEventListener('click', toggleTheme);

        // 点击页面其他地方关闭搜索结果
        document.addEventListener('click', (e) => {
            const isClickInside = searchInput.contains(e.target) || 
                                 searchResults.contains(e.target) ||
                                 searchBtn.contains(e.target) ||
                                 themeToggle.contains(e.target);
            
            if (!isClickInside) {
                searchResults.classList.add('hidden');
            }
        });

        // 初始化时加载数据
        loadToolsData();

        // 加载工具数据
        async function loadToolsData() {
            if (isDataLoaded || isLoading) {
                return;
            }
            
            isLoading = true;
            
            try {
                // 尝试从data.json加载数据
                const response = await fetch('/assets/data/data.json');
                
                if (!response.ok) {
                    throw new Error('网络请求失败');
                }
                
                toolsData = await response.json();
                isDataLoaded = true;
            } catch (error) {
                console.error('加载数据失败:', error);
                // 使用备用数据，避免搜索功能完全失效
                toolsData = [
                    { id: 1, name: "React", category: "Frontend", tags: ["Framework", "JavaScript"], popularity: 1 },
                    { id: 2, name: "Vue", category: "Frontend", tags: ["Framework", "JavaScript"], popularity: 1 },
                    { id: 3, name: "Docker", category: "DevOps", tags: ["Container", "Deployment"], popularity: 1 },
                    { id: 4, name: "Python", category: "Languages", tags: ["Programming", "Backend"], popularity: 1 },
                    { id: 5, name: "JavaScript", category: "Languages", tags: ["Programming", "Frontend"], popularity: 1 }
                ];
            } finally {
                isLoading = false;
            }
        }

        // 切换主题模式
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            updateTheme();
        }

        // 更新主题显示
        function updateTheme() {
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                themeIcon.classList.remove('fa-moon-o');
                themeIcon.classList.add('fa-sun-o');
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.classList.remove('fa-sun-o');
                themeIcon.classList.add('fa-moon-o');
            }
        }

        // 处理输入事件
        function handleInput() {
            const value = searchInput.value.trim();
            
            // 显示或隐藏清除按钮
            if (value) {
                clearBtn.classList.remove('opacity-0');
                clearBtn.classList.add('opacity-100');
            } else {
                clearBtn.classList.remove('opacity-100');
                clearBtn.classList.add('opacity-0');
                searchResults.classList.add('hidden');
            }
            
            // 输入内容足够时自动搜索
            if (value.length >= 1) {
                performSearch();
            }
        }

        // 清除搜索内容
        function clearSearch() {
            searchInput.value = '';
            clearBtn.classList.remove('opacity-100');
            clearBtn.classList.add('opacity-0');
            searchResults.classList.add('hidden');
            searchInput.focus();
        }

        // 执行搜索
        async function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            
            if (!query) {
                return;
            }
            
            // 确保数据已加载
            if (!isDataLoaded && !isLoading) {
                await loadToolsData();
            }
            
            // 显示搜索结果容器和加载状态
            searchResults.classList.remove('hidden');
            resultsList.classList.add('hidden');
            noResults.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            
            // 模拟网络延迟
            setTimeout(() => {
                // 过滤结果 - 搜索名称、类别和标签
                const filteredResults = toolsData.filter(item => 
                    item.name.toLowerCase().includes(query) || 
                    item.category.toLowerCase().includes(query) ||
                    item.tags.some(tag => tag.toLowerCase().includes(query))
                );
                
                // 更新UI
                loadingIndicator.classList.add('hidden');
                
                if (filteredResults.length > 0) {
                    displayResults(filteredResults, query);
                    resultsList.classList.remove('hidden');
                    noResults.classList.add('hidden');
                } else {
                    resultsList.classList.add('hidden');
                    noResults.classList.remove('hidden');
                }
            }, 300); // 模拟300ms网络延迟
        }

        // 显示搜索结果
        function displayResults(results, query) {
            resultsList.innerHTML = '';
            
            results.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-3 hover:result-item-hover cursor-pointer';
                
                // 高亮匹配的文本
                const highlightedName = highlightMatch(item.name, query);
                const highlightedCategory = highlightMatch(item.category, query);
                const tagsText = item.tags.join('、');
                const highlightedTags = highlightMatch(tagsText, query);
                
                // 生成流行度图标
                let popularityStars = '';
                const popularity = item.popularity || 0;
                if (popularity >= 1) {
                    popularityStars = '<i class="fa fa-star text-yellow-400"></i><i class="fa fa-star text-yellow-400"></i><i class="fa fa-star text-yellow-400"></i>';
                } else if (popularity >= 0.66) {
                    popularityStars = '<i class="fa fa-star text-yellow-400"></i><i class="fa fa-star text-yellow-400"></i><i class="fa fa-star-o text-gray-400"></i>';
                } else {
                    popularityStars = '<i class="fa fa-star text-yellow-400"></i><i class="fa fa-star-o text-gray-400"></i><i class="fa fa-star-o text-gray-400"></i>';
                }
                
                li.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-800 dark:text-white mode-transition">${highlightedName}</h3>
                            <p class="text-xs text-neutral dark:text-gray-400 mt-1 mode-transition">${highlightedTags}</p>
                        </div>
                        <div class="flex flex-col items-end ml-2">
                            <span class="text-xs px-2 py-1 bg-primary/10 text-primary rounded-full mb-1">${highlightedCategory}</span>
                            <div class="text-xs text-yellow-500 dark:text-yellow-400">${popularityStars}</div>
                        </div>
                    </div>
                `;
                
                // 点击结果项的处理
                li.addEventListener('click', () => {
                    // 在实际应用中，这里可以跳转到对应的详情页
                    alert(`您选择了: ${item.name}`);
                    searchResults.classList.add('hidden');
                });
                
                resultsList.appendChild(li);
            });
        }

        // 高亮匹配的文本
        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="text-primary font-medium">$1</span>');
        }

        // 微信浏览器特殊处理 - 防止橡皮筋效果影响体验
        document.body.addEventListener('touchmove', (e) => {
            // 仅在搜索结果显示时阻止页面滚动
            if (!searchResults.classList.contains('hidden')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
    <script type="module" src="/main.js"></script>
</body>
</html>