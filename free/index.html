<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dev Tools Catalog</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome图标 -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 自定义Tailwind配置 -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5', // 项目规则中定义的主色 - Indigo
            secondary: '#10B981', // 项目规则中定义的辅色 - Green
            accent: '#F59E0B', // 项目规则中定义的强调色 - Amber
            dark: {
              bg: '#121212',
              card: '#1E1E1E',
              border: '#333333',
              text: '#E0E0E0'
            },
            light: {
              bg: '#F8FAFC',
              card: '#FFFFFF',
              border: '#E2E8F0',
              text: '#1E293B'
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .category-item {
        @apply py-2 px-4 cursor-pointer transition-all duration-200 hover:bg-primary/10 
               border-l-4 border-transparent hover:border-primary/70 rounded-r-lg;
      }
      .category-item-active {
        @apply bg-primary/10 border-primary font-medium shadow-sm;
      }
      /* 其他工具类保持不变 */
      .tag-item { /* 保持不变 */ }
      .sortable-header { /* 保持不变 */ }
      .sort-indicator { /* 保持不变 */ }
      .table-row-hover {
        @apply hover:bg-primary/5 dark:hover:bg-primary/10 transition-colors duration-200 transform hover:-translate-y-0.5;
      }
      .card-hover {
        @apply hover:shadow-md hover:border-primary/30 transition-all duration-200 transform hover:-translate-y-1 hover:shadow-primary/10;
      }
      .theme-toggle { /* 保持不变 */ }
      /* 添加搜索结果高亮样式 */
      .search-result-active {
        @apply bg-primary/20 dark:bg-primary/25 border-primary/30 scale-[1.01] transition-all duration-200;
      }
      .search-result-active td:first-child a {
        @apply font-semibold text-primary;
      }
    }
  </style>
</head>
<body class="font-inter bg-light-bg text-light-text dark:bg-dark-bg dark:text-dark-text min-h-screen flex flex-col transition-colors duration-300">
  <!-- 主导航 -->
  <nav class="bg-white dark:bg-gray-900 border-b border-light-border dark:border-dark-border shadow-sm">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between h-14">
        <!-- Logo -->
        <a href="/" class="flex items-center">
          <i class="fa fa-wrench mr-2 text-primary" aria-hidden="true"></i>
          <span class="text-lg font-semibold text-gray-700 dark:text-gray-200">FreeDevTools</span>
        </a>

        <!-- Desktop Navigation Links -->
        <div class="hidden md:flex space-x-6">
          <a href="/" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white px-3 py-2 text-sm font-medium">Home</a>
          <a href="/free/" class="text-primary border-b-2 border-primary px-3 py-2 text-sm font-medium">Free Tools</a>
          <a href="/developer/" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white px-3 py-2 text-sm font-medium">Developer Resources</a>
          <a href="/my-history.html" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white px-3 py-2 text-sm font-medium">My History</a>
          <a href="/about.html" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white px-3 py-2 text-sm font-medium">About</a>
        </div>

        <!-- Theme toggle button -->
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme mode">
          <i id="light-icon" class="fa fa-moon-o" aria-hidden="true"></i>
          <i id="dark-icon" class="fa fa-sun-o hidden" aria-hidden="true"></i>
        </button>

        <!-- Mobile menu button -->
        <div class="md:hidden">
          <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none">
            <i class="fa fa-bars" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- Mobile Navigation Menu -->
      <div id="mobile-menu" class="hidden md:hidden">
        <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
          <a href="/" class="block px-3 py-2 text-base font-medium text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white">Home</a>
          <a href="/free/" class="block px-3 py-2 text-base font-medium bg-primary/10 text-primary">Free Tools</a>
          <a href="/developer/" class="block px-3 py-2 text-base font-medium text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white">Developer Resources</a>
          <a href="/my-history.html" class="block px-3 py-2 text-base font-medium text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white">My History</a>
          <a href="/about.html" class="block px-3 py-2 text-base font-medium text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white">About</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- 面包屑导航 - 移动到导航下方 -->
  <div class="bg-white dark:bg-gray-900 border-b border-light-border dark:border-dark-border py-2">
    <div class="container mx-auto px-4">
      <nav class="flex text-sm" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
          <li class="inline-flex items-center">
            <a href="/" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white">
              <i class="fa fa-home mr-1"></i> Home
            </a>
          </li>
          <li>
            <div class="flex items-center">
              <i class="fa fa-angle-right text-gray-400 mx-1"></i>
              <a href="/free/" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-white">
                Free Resources
              </a>
            </div>
          </li>
          <li aria-current="page">
            <div class="flex items-center">
              <i class="fa fa-angle-right text-gray-400 mx-1"></i>
              <span class="text-gray-700 dark:text-gray-200">Tools Catalog</span>
            </div>
          </li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Hero Section -->
  <header class="bg-gradient-to-r from-primary/90 to-primary/70 shadow-md border-b border-primary/20">
    <div class="container mx-auto px-4 py-6">
      <div class="flex flex-col items-center text-center relative">
        <!-- 添加装饰性元素 -->
        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12 blur-xl"></div>
        
        <h1 class="text-2xl md:text-3xl font-bold text-white mb-2 relative z-10">Dev Tools Catalog</h1>
        <p class="text-blue-100 max-w-lg mb-4 relative z-10">
          A comprehensive collection of modern developer tools, frameworks, and resources.
        </p>
        <!-- 添加简单的统计数据，增强信息密度 -->
        <div class="flex space-x-6 text-white/80 text-sm">
          <div class="flex items-center"><i class="fa fa-puzzle-piece mr-1"></i> 1000+ Tools</div>
          <div class="flex items-center"><i class="fa fa-th-large mr-1"></i> 30+ Categories</div>
        </div>
      </div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <main class="flex-1 flex flex-col md:flex-row">
    <!-- Sidebar: Category navigation -->
    <aside class="hidden md:block bg-white dark:bg-dark-card w-full md:w-56 border-r border-light-border dark:border-dark-border p-3 transition-colors duration-300">
      <div class="p-2 border-b border-light-border dark:border-dark-border mb-2">
        <h2 class="font-bold text-gray-800 dark:text-gray-200 text-sm">Categories</h2>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="category-count">0 categories</p>
      </div>
      
      <nav id="categories-nav" class="divide-y divide-gray-100 dark:divide-dark-border text-sm">
        <!-- Categories generated by JS (including All Tools) -->
        <div class="flex justify-center p-4">
          <div class="w-6 h-6 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        </div>
      </nav>
    </aside>

    <!-- 右侧内容区域 -->
    <div class="flex-1 p-4">
      <!-- Toolbar: search, result count, view switch -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <div class="flex items-center w-full sm:w-auto gap-3">
          <div class="relative w-full sm:w-80 md:w-96">
            <input type="text" id="search-input" 
                  class="w-full px-4 py-3 border border-light-border dark:border-dark-border bg-white dark:bg-dark-card rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm transition-all duration-200 shadow-sm" 
                  placeholder="Search tools..." 
                  autocomplete="off">
            <button id="clear-search" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors hidden">
              <i class="fa fa-times"></i>
            </button>
          </div>
          
          <!-- Result count -->
          <div class="text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap">
            <span id="results-count">0</span> results
          </div>
        </div>
        
        <div class="flex items-center gap-2 bg-white dark:bg-dark-card border border-light-border dark:border-dark-border rounded-lg p-1">
          <button id="table-view-btn" class="px-3 py-1 rounded bg-primary text-white text-sm transition-all duration-200">
            <i class="fa fa-table mr-1"></i> Table
          </button>
          <button id="card-view-btn" class="px-3 py-1 rounded text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm transition-all duration-200">
            <i class="fa fa-th-large mr-1"></i> Card
          </button>
        </div>
      </div>
      
      <!-- 所有内容区域 -->
      <div id="all-content" class="bg-white dark:bg-dark-card rounded-lg shadow-sm overflow-hidden border border-light-border dark:border-dark-border transition-colors duration-300">
        <!-- 表格视图 -->
        <div id="table-view" class="overflow-x-auto">
          <table class="min-w-full divide-y divide-light-border dark:divide-dark-border">
            <thead class="bg-gray-50 dark:bg-gray-800">
              <tr>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider sortable-header" data-sort="name">
                  Name
                  <i class="fa fa-sort sort-indicator"></i>
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider sortable-header" data-sort="category">
                  Category
                  <i class="fa fa-sort sort-indicator"></i>
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider sortable-header" data-sort="tags">
                  Tags
                  <i class="fa fa-sort sort-indicator"></i>
                </th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider sortable-header" data-sort="popularity">
                  Popularity
                  <i class="fa fa-sort sort-indicator"></i>
                </th>
                <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider sortable-header" data-sort="favorite">
                  <i class="fa fa-heart mr-1"></i>
                  Favorite
                  <i class="fa fa-sort sort-indicator"></i>
                </th>
              </tr>
            </thead>
            <tbody id="tools-table-body" class="bg-white dark:bg-dark-card divide-y divide-light-border dark:divide-dark-border">
              <!-- 表格内容将通过JS动态生成 -->
            </tbody>
          </table>
        </div>
        
        <!-- 卡片视图 -->
        <div id="card-view" class="hidden p-4">
          <div id="tools-card-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
            <!-- 卡片内容将通过JS动态生成 -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 简化的页脚 -->
  <footer class="bg-light-bg text-light-text py-4 mt-4 dark:bg-gray-900 dark:text-white">
    <div class="container mx-auto px-4 text-center">
      <p class="font-bold text-sm mb-1">Dev Tools Catalog</p>
      <p class="text-gray-400 text-xs">A comprehensive developer tools collection</p>
      <div class="mt-2 text-gray-400 text-xs">
        &copy; 2024 Dev Tools Catalog. All rights reserved.
      </div>
    </div>
  </footer>

  <!-- JavaScript 逻辑 -->
  <script>
    // 添加移动菜单切换功能
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
    }

    // 全局变量
    let toolsData = [];
    let filteredTools = [];
    let categories = {};
    let allTags = new Set();
    let activeCategory = 'all'; // 默认选中All Tools
    // 从localStorage读取上次保存的视图，如果没有则使用默认表格视图
    let currentView = localStorage.getItem('preferredView') || 'table';
    let sortConfig = {
      key: null,
      direction: 'asc' // 'asc' 或 'desc'
    };
    // 视图模式（已删除图片视图）
    const VIEW_MODES = {
      TABLE: 'table',
      CARD: 'card'
    };
    // 使用与项目其他部分一致的收藏键名
    const BOOKMARK_KEY = 'bookmarks_v1';
    // 获取收藏的工具列表
    let favorites = JSON.parse(localStorage.getItem('favoritedTools') || '[]');
    // 添加搜索结果选中相关变量
    let selectedResultIndex = -1;
    let searchActive = false;
    // 兼容项目其他部分的收藏数据格式
    function syncFavorites() {
      const bookmarks = readBookmarks();
      if (bookmarks.length > 0) {
        // 转换为当前页面使用的格式
        favorites = bookmarks.map(b => b.url.split('/').pop());
        localStorage.setItem('favoritedTools', JSON.stringify(favorites));
      }
    }
    // 读取收藏数据（与项目其他部分保持一致）
    function readBookmarks() {
      try {
        return JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]');
      } catch {
        return [];
      }
    }
    // 写入收藏数据（与项目其他部分保持一致）
    function writeBookmarks(list) {
      localStorage.setItem(BOOKMARK_KEY, JSON.stringify(list));
    }
    
    // DOM 元素
    const categoriesNav = document.getElementById('categories-nav');
    const categoryCount = document.getElementById('category-count');
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    const resultsCountEl = document.getElementById('results-count');
    const toolsTableBody = document.getElementById('tools-table-body');
    const toolsCardContainer = document.getElementById('tools-card-container');
    const tableView = document.getElementById('table-view');
    const cardView = document.getElementById('card-view');
    const tableViewBtn = document.getElementById('table-view-btn');
    const cardViewBtn = document.getElementById('card-view-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const lightIcon = document.getElementById('light-icon');
    const darkIcon = document.getElementById('dark-icon');

    // Initialization function
    async function init() {
      try {
        // Check user's preferred theme mode
        checkPreferredTheme();
        
        // 同步收藏数据
        syncFavorites();
        
        // 检查URL参数是否有搜索词
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('q');
        
        // 如果有搜索词，先设置到搜索框中
        if (searchQuery) {
          searchInput.value = searchQuery;
          clearSearchBtn.classList.remove('hidden');
        }
        
        // Load JSON data
        toolsData = await loadToolsData();
        filteredTools = [...toolsData];
        
        // Process data
        processData();
        
        // Render page (including All Tools in all categories)
        renderCategories();
        updateResultsCount();
        
        // 如果有搜索词，执行搜索
        if (searchQuery) {
          filterBySearch();
        } else {
          renderTools();
        }
        
        // Update stats (category count does not include All Tools)
        categoryCount.textContent = `${Object.keys(categories).length} categories`;
        
        // Add sorting event listeners
        document.querySelectorAll('.sortable-header').forEach(header => {
          header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            
            // Toggle direction if already sorted by this key
            if (sortConfig.key === sortKey) {
              sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
              sortConfig.key = sortKey;
              sortConfig.direction = 'asc';
            }
            
            updateSortIndicators();
            sortTools();
            renderTools();
            highlightSelectedResult(); // 重新高亮选中结果
          });
        });
        
        // Theme toggle event
        themeToggle.addEventListener('click', toggleTheme);
        
        // 设置初始视图模式（根据localStorage中的值）
        setTimeout(() => {
          switchView(currentView);
        }, 100);
        
        // 添加搜索框键盘事件监听
        searchInput.addEventListener('keydown', handleSearchKeydown);
        
      } catch (error) {
        categoriesNav.innerHTML = `
          <div class="p-4 text-center">
            <i class="fa fa-exclamation-circle text-red-500 text-xl mb-2"></i>
            <h3 class="text-sm font-semibold text-red-800 dark:text-red-400 mb-1">Data load error</h3>
            <p class="text-red-600 dark:text-red-300 text-xs">${error.message}</p>
          </div>
        `;
        console.error('Initialization error:', error);
      }
    }

    // 检查用户偏好的主题
    function checkPreferredTheme() {
      // 检查本地存储中的主题设置
      const savedTheme = localStorage.getItem('theme');
      
      if (savedTheme === 'dark') {
        enableDarkMode();
      } else if (savedTheme === 'light') {
        enableLightMode();
      } else {
        // 如果没有保存的设置，使用用户系统偏好
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          enableDarkMode();
        } else {
          enableLightMode();
        }
      }
    }

    // 启用浅色模式
    function enableLightMode() {
      document.documentElement.classList.remove('dark');
      lightIcon.style.display = 'inline-block';
      darkIcon.style.display = 'none';
      localStorage.setItem('theme', 'light');
    }

    // 启用深色模式
    function enableDarkMode() {
      document.documentElement.classList.add('dark');
      lightIcon.style.display = 'none';
      darkIcon.style.display = 'inline-block';
      localStorage.setItem('theme', 'dark');
    }

    // 切换主题
    function toggleTheme() {
      if (document.documentElement.classList.contains('dark')) {
        enableLightMode();
      } else {
        enableDarkMode();
      }
    }

    // 切换工具的收藏状态
    function toggleFavorite(toolId) {
      // 检查工具是否已收藏
      const index = favorites.indexOf(toolId);
      
      if (index > -1) {
        // 如果已收藏，则取消收藏
        favorites.splice(index, 1);
        // 同时从项目全局收藏中移除
        const bookmarks = readBookmarks();
        const bookmarkIndex = bookmarks.findIndex(b => b.url === `/free/detail/${toolId}`);
        if (bookmarkIndex > -1) {
          bookmarks.splice(bookmarkIndex, 1);
          writeBookmarks(bookmarks);
        }
      } else {
        // 如果未收藏，则添加到收藏
        favorites.push(toolId);
        // 同时添加到项目全局收藏
        const tool = toolsData.find(t => t.file === toolId);
        if (tool) {
          const bookmarks = readBookmarks();
          bookmarks.unshift({
            title: tool.name,
            url: `/free/detail/${toolId}`,
            ts: Date.now()
          });
          writeBookmarks(bookmarks);
        }
      }
      
      // 保存更新后的收藏列表到localStorage
      localStorage.setItem('favoritedTools', JSON.stringify(favorites));
      
      // 只更新点击的按钮状态，而不是重新渲染所有视图
      const buttons = document.querySelectorAll(`[data-tool-id="${toolId}"]`);
      buttons.forEach(btn => {
        const isFav = isFavorited(toolId);
        const icon = btn.querySelector('i');
        if (icon) {
          icon.className = isFav ? 'fa fa-star text-yellow-500' : 'fa fa-star-o';
        }
      });
      
      // 如果当前正在按收藏排序，重新排序
      if (sortConfig.key === 'favorite') {
        sortTools();
        renderTools();
      }
    }
    
    // 检查工具是否已收藏
    function isFavorited(toolId) {
      return favorites.includes(toolId);
    }

    // 加载工具数据
    async function loadToolsData() {
      try {
        // 使用fetch从正确的路径加载数据
        const response = await fetch('/assets/data/data.json');
        // 检查响应状态
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        // 解析JSON数据
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Failed to load tools data:', error);
        // 在出错时提供一个最小的默认数据集，确保应用程序仍能工作
        return [
          {"file":"react","name":"React","category":"Frontend","tags":["Framework","JavaScript","UI"],"popularity":1},
          {"file":"vue","name":"Vue","category":"Frontend","tags":["Framework","JavaScript"],"popularity":1},
          {"file":"tailwind","name":"Tailwind","category":"Frontend","tags":["UI Framework","CSS Tools"],"popularity":1},
          {"file":"redis","name":"Redis","category":"Database","tags":["Cache","NoSQL"],"popularity":1}
        ];
      }
    }

    // Process data: organize by category and extract tags
    function processData() {
      // Clear categories and tags for re-init
      categories = {};
      allTags = new Set();
      toolsData.forEach(tool => {
        const { category } = tool;
        if (!categories[category]) {
          categories[category] = {
            tags: new Set(),
            tools: []
          };
        }
        categories[category].tools.push(tool);
        tool.tags.forEach(tag => {
          categories[category].tags.add(tag);
          allTags.add(tag);
        });
      });
    }

    // Render category navigation - including All Tools
    function renderCategories() {
      // 先清空内容以移除旧的事件监听器
      categoriesNav.innerHTML = '';
      
      // 构建分类数组：All Tools 在前，然后是其他分类
      let allCategories = [
        { id: 'all', name: 'All Tools', count: toolsData.length }
      ];
      Object.keys(categories).sort().forEach(category => {
        allCategories.push({
          id: category,
          name: category,
          count: categories[category].tools.length
        });
      });
      
      // 生成HTML
      let html = '';
      allCategories.forEach(category => {
        html += `
          <div class="category-item" data-category="${category.id}" style="border-left-color: ${activeCategory === category.id ? '#10B981' : 'transparent'}">
            <div class="flex justify-between items-center">
              <span>${category.name}</span>
              <span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs px-2 py-0.5 rounded-full">
                ${category.count}
              </span>
            </div>
          </div>
        `;
      });
      categoriesNav.innerHTML = html;
      
      // 设置活动类和边框
      document.querySelectorAll('.category-item').forEach(item => {
        if(item.dataset.category === activeCategory){
          item.classList.add('category-item-active');
          item.style.borderLeftColor = '#10B981';
        } else {
          item.classList.remove('category-item-active');
          item.style.borderLeftColor = 'transparent';
        }
        
        item.addEventListener('mouseenter', () => {
          if(!item.classList.contains('category-item-active')) {
            item.style.borderLeftColor = '#10B981';
          }
        });
        item.addEventListener('mouseleave', () => {
          if(!item.classList.contains('category-item-active')) {
            item.style.borderLeftColor = 'transparent';
          }
        });
      });
      // Click event
      document.querySelectorAll('.category-item').forEach(el => {
        el.addEventListener('click', () => {
          activeCategory = el.dataset.category;
          renderCategories(); // Keep active style in sync
          filterByCategory(activeCategory);
          // Reset search
          searchInput.value = '';
          clearSearchBtn.classList.add('hidden');
        });
      });
    }

    // 按分类筛选工具
    function filterByCategory(category) {
      activeCategory = category;
      
      if (category === 'all') {
        filteredTools = [...toolsData];
      } else {
        filteredTools = categories[category].tools;
      }
      
      // 保持排序状态
      if (sortConfig.key) {
        sortTools();
      }
      
      updateResultsCount();
      renderTools();
    }

    // 按搜索词筛选工具
    function filterBySearch() {
      const searchTermValue = searchInput.value.toLowerCase().trim();
      
      // 显示/隐藏清空按钮
      if (searchTermValue) {
        clearSearchBtn.classList.remove('hidden');
        searchActive = true;
      } else {
        clearSearchBtn.classList.add('hidden');
        // 搜索为空时根据当前分类筛选
        filterByCategory(activeCategory || 'all');
        searchActive = false;
        selectedResultIndex = -1;
        return;
      }
      
      // 根据搜索词筛选
      filteredTools = toolsData.filter(tool => {
        // 如果有活跃分类，先匹配分类
        if (activeCategory && activeCategory !== 'all' && tool.category !== activeCategory) {
          return false;
        }
        
        // 匹配工具名称或标签
        return tool.name.toLowerCase().includes(searchTermValue) ||
               tool.tags.some(tag => tag.toLowerCase().includes(searchTermValue));
      });
      
      // 搜索结果特殊排序：以搜索词开头的结果排在最前面
      filteredTools.sort((a, b) => {
        const aStartsWith = a.name.toLowerCase().startsWith(searchTermValue);
        const bStartsWith = b.name.toLowerCase().startsWith(searchTermValue);
        
        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;
        
        // 都以搜索词开头或都不以搜索词开头时，按popularity排序
        return b.popularity - a.popularity;
      });
      
      // 默认选中第一条结果
      selectedResultIndex = filteredTools.length > 0 ? 0 : -1;
      
      updateResultsCount();
      renderTools();
      highlightSelectedResult();
    }

    // 更新结果计数显示
    function updateResultsCount() {
      resultsCountEl.textContent = filteredTools.length;
    }

    // 按当前配置排序工具
    function sortTools() {
      if (!sortConfig.key) return;
      
      filteredTools.sort((a, b) => {
        let valueA, valueB;
        
        // 根据排序键获取比较值
        switch (sortConfig.key) {
          case 'name':
            valueA = a.name.toLowerCase();
            valueB = b.name.toLowerCase();
            break;
          case 'category':
            valueA = a.category.toLowerCase();
            valueB = b.category.toLowerCase();
            break;
          case 'tags':
            // 按第一个标签排序
            valueA = a.tags.length > 0 ? a.tags[0].toLowerCase() : '';
            valueB = b.tags.length > 0 ? b.tags[0].toLowerCase() : '';
            break;
          case 'popularity':
            valueA = a.popularity;
            valueB = b.popularity;
            break;
          case 'favorite':
            // 按收藏状态排序
            valueA = isFavorited(a.file) ? 1 : 0;
            valueB = isFavorited(b.file) ? 1 : 0;
            // 特殊处理：收藏的排在前面
            if (valueA !== valueB) {
              return sortConfig.direction === 'asc' ? valueB - valueA : valueA - valueB;
            }
            // 如果收藏状态相同，默认按名称排序
            valueA = a.name.toLowerCase();
            valueB = b.name.toLowerCase();
            break;
          default:
            return 0;
        }
        
        // 比较并应用排序方向
        if (valueA < valueB) return sortConfig.direction === 'asc' ? -1 : 1;
        if (valueA > valueB) return sortConfig.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    // 更新排序指示器
    function updateSortIndicators() {
      // 重置所有指示器
      document.querySelectorAll('.sortable-header i').forEach(icon => {
        icon.className = 'fa fa-sort sort-indicator';
      });
      
      // 设置当前排序指示器
      if (sortConfig.key) {
        const header = document.querySelector(`.sortable-header[data-sort="${sortConfig.key}"] i`);
        if (header) {
          header.className = `fa fa-sort-${sortConfig.direction} sort-indicator`;
        }
      }
    }

    // 渲染工具列表（表格和卡片视图）
    function renderTools() {
      // 渲染表格视图
      renderTableView();
      
      // 渲染卡片视图
      renderCardView();
    }
    
    // Render table view
    function renderTableView() {
      if (filteredTools.length === 0) {
        toolsTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
              No matching tools found
            </td>
          </tr>
        `;
        return;
      }
      toolsTableBody.innerHTML = filteredTools.map(tool => {
        const toolLink = `/free/detail/${tool.file}`;
        
        // 热度状态图标
        let popularityIcon = '';
        if (tool.popularity >= 0.8) {
          popularityIcon = `<i class="fa fa-trophy text-amber-500 animate-pulse" title="Popular (${Math.round(tool.popularity * 100)}%)"></i>`;
        } else if (tool.popularity >= 0.5) {
          popularityIcon = `<i class="fa fa-arrow-circle-up text-blue-500" title="Growing (${Math.round(tool.popularity * 100)}%)"></i>`;
        } else {
          popularityIcon = `<i class="fa fa-arrow-circle-down text-gray-400" title="Declining (${Math.round(tool.popularity * 100)}%)"></i>`;
        }
        
        return `
          <tr class="table-row-hover">
            <td class="px-4 py-3 whitespace-nowrap">
              <a href="${toolLink}" class="text-primary hover:underline text-sm font-medium transition-colors duration-200" target="_blank">
                ${tool.name}
              </a>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
              <span class="category-item bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-xs" data-category="${tool.category}">
                ${tool.category}
              </span>
            </td>
            <td class="px-4 py-3">
              <div class="flex flex-wrap gap-1">
                ${tool.tags.map(tag => `
                  <span class="tag-item tag-item-primary" data-tag="${tag}">
                    ${tag}
                  </span>
                `).join('')}
              </div>
            </td>
            <td class="px-4 py-3 text-center">
              ${popularityIcon}
            </td>
            <td class="px-4 py-3 text-center">
              <button class="favorite-btn text-gray-400 hover:text-yellow-500 transition-colors" data-tool-id="${tool.file}">
                <i class="fa ${isFavorited(tool.file) ? 'fa-star text-yellow-500' : 'fa-star-o'}"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      // Category click event in table
      document.querySelectorAll('#tools-table-body .category-item').forEach(catEl => {
        catEl.addEventListener('click', () => {
          const category = catEl.dataset.category;
          filterByCategory(category);
        });
      });
      // Tag click event in table
      document.querySelectorAll('#tools-table-body .tag-item').forEach(tagEl => {
        tagEl.addEventListener('click', () => {
          const tag = tagEl.dataset.tag;
          filterByTag(tag);
        });
      });
      
      // Favorite button click event in table
      document.querySelectorAll('#tools-table-body .favorite-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const toolId = btn.dataset.toolId;
          toggleFavorite(toolId);
        });
      });
    }

    // Render card view
    function renderCardView() {
      if (filteredTools.length === 0) {
        toolsCardContainer.innerHTML = `
          <div class="col-span-full bg-gray-50 dark:bg-gray-800 rounded-lg p-6 text-center">
            <i class="fa fa-search text-gray-300 dark:text-gray-600 text-2xl mb-2"></i>
            <p class="text-gray-500 dark:text-gray-400 text-sm">No matching tools found</p>
          </div>
        `;
        return;
      }
      toolsCardContainer.innerHTML = filteredTools.map(tool => {
        const toolLink = `/free/detail/${tool.file}`;
        
        // 热度状态图标
        let popularityIcon = '';
        if (tool.popularity >= 0.8) {
          popularityIcon = `<i class="fa fa-trophy text-amber-500 animate-pulse" title="Popular (${Math.round(tool.popularity * 100)}%)"></i>`;
        } else if (tool.popularity >= 0.5) {
          popularityIcon = `<i class="fa fa-arrow-circle-up text-blue-500" title="Growing (${Math.round(tool.popularity * 100)}%)"></i>`;
        } else {
          popularityIcon = `<i class="fa fa-arrow-circle-down text-gray-400" title="Declining (${Math.round(tool.popularity * 100)}%)"></i>`;
        }
        
        return `
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg border border-light-border dark:border-dark-border shadow-sm p-3 card-hover flex flex-col h-full relative">
            <button class="favorite-btn absolute top-3 right-3 text-gray-400 hover:text-yellow-500 transition-colors z-10" data-tool-id="${tool.file}">
              <i class="fa ${isFavorited(tool.file) ? 'fa-star text-yellow-500' : 'fa-star-o'}"></i>
            </button>
            <h3 class="font-semibold text-base mb-2">
              <a href="${toolLink}" class="text-primary hover:underline transition-colors duration-200" target="_blank">
                ${tool.name}
              </a>
            </h3>
            <div class="flex flex-wrap gap-1 mb-2">
              ${tool.tags.map(tag => `
                <span class="tag-item tag-item-primary" data-tag="${tag}">
                  ${tag}
                </span>
              `).join('')}
            </div>
            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400 mb-2">
              <span class="category-item bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded mr-2" data-category="${tool.category}">
                ${tool.category}
              </span>
              ${popularityIcon}
            </div>
          </div>
        `;
      }).join('');
      // Category click event in cards
      document.querySelectorAll('#tools-card-container .category-item').forEach(catEl => {
        catEl.addEventListener('click', () => {
          const category = catEl.dataset.category;
          filterByCategory(category);
        });
      });
      // Tag click event in cards
      document.querySelectorAll('#tools-card-container .tag-item').forEach(tagEl => {
        tagEl.addEventListener('click', () => {
          const tag = tagEl.dataset.tag;
          filterByTag(tag);
        });
      });
      
      // Favorite button click event in cards
      document.querySelectorAll('#tools-card-container .favorite-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const toolId = btn.dataset.toolId;
          toggleFavorite(toolId);
        });
      });
    }

    // 按标签筛选工具
    function filterByTag(tag) {
      filteredTools = toolsData.filter(tool => {
        // 如果有活跃分类，先匹配分类
        if (activeCategory && activeCategory !== 'all' && tool.category !== activeCategory) {
          return false;
        }
        
        return tool.tags.includes(tag);
      });
      
      // 保持排序状态
      if (sortConfig.key) {
        sortTools();
      }
      
      updateResultsCount();
      renderTools();
    }

    // 切换视图模式（表格/卡片）
    function switchView(viewType) {
      currentView = viewType;
      
      // 保存当前视图选择到localStorage
      localStorage.setItem('preferredView', viewType);
      
      if (viewType === 'table') {
        // 显示表格视图，隐藏其他视图
        tableView.classList.remove('hidden');
        cardView.classList.add('hidden');
        
        // 更新按钮样式
        tableViewBtn.classList.add('bg-primary', 'text-white');
        tableViewBtn.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
        cardViewBtn.classList.remove('bg-primary', 'text-white');
        cardViewBtn.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
      } else if (viewType === 'card') {
        // 显示卡片视图，隐藏其他视图
        tableView.classList.add('hidden');
        cardView.classList.remove('hidden');
        
        // 更新按钮样式
        cardViewBtn.classList.add('bg-primary', 'text-white');
        cardViewBtn.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
        tableViewBtn.classList.remove('bg-primary', 'text-white');
        tableViewBtn.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
      }
      
      // 视图切换后重新高亮选中的结果
      if (searchActive && selectedResultIndex >= 0) {
        setTimeout(() => {
          highlightSelectedResult();
        }, 100);
      }
    }

    // 高亮选中的搜索结果
    function highlightSelectedResult() {
      // 移除所有高亮
      document.querySelectorAll('.search-result-active').forEach(el => {
        el.classList.remove('search-result-active');
      });
      
      if (selectedResultIndex < 0 || selectedResultIndex >= filteredTools.length) {
        return;
      }
      
      const currentView = localStorage.getItem('preferredView') || 'table';
      let resultElement;
      
      if (currentView === 'table') {
        // 表格视图中查找对应行
        const rows = document.querySelectorAll('#tools-table-body tr');
        resultElement = rows[selectedResultIndex];
      } else {
        // 卡片视图中查找对应卡片
        const cards = document.querySelectorAll('#tools-card-container > div');
        resultElement = cards[selectedResultIndex];
      }
      
      // 添加高亮类
      if (resultElement) {
        resultElement.classList.add('search-result-active');
        // 滚动到选中元素
        resultElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }
    
    // 打开选中的搜索结果
    function openSelectedResult() {
      if (selectedResultIndex < 0 || selectedResultIndex >= filteredTools.length) {
        return;
      }
      
      const tool = filteredTools[selectedResultIndex];
      const toolLink = `/free/detail/${tool.file}`;
      window.open(toolLink, '_blank');
    }
    
    // 处理搜索框的键盘事件
    function handleSearchKeydown(event) {
      // 只有在搜索框聚焦且有搜索结果时才处理箭头键
      if (!searchActive || filteredTools.length === 0) {
        return;
      }
      
      switch (event.key) {
        case 'ArrowDown':
          event.preventDefault();
          selectedResultIndex = (selectedResultIndex + 1) % filteredTools.length;
          highlightSelectedResult();
          break;
          
        case 'ArrowUp':
          event.preventDefault();
          selectedResultIndex = (selectedResultIndex - 1 + filteredTools.length) % filteredTools.length;
          highlightSelectedResult();
          break;
          
        case 'Enter':
          // 如果按下回车键，且有选中的结果，则打开该结果
          if (selectedResultIndex >= 0 && selectedResultIndex < filteredTools.length) {
            event.preventDefault();
            openSelectedResult();
          }
          break;
          
        case 'Escape':
          // 按下ESC键，清除搜索
          clearSearch();
          break;
      }
    }

    // 清空搜索
    function clearSearch() {
      searchInput.value = '';
      clearSearchBtn.classList.add('hidden');
      searchActive = false;
      selectedResultIndex = -1;
      filterByCategory(activeCategory || 'all');
    }

    // 事件监听
    searchInput.addEventListener('input', filterBySearch);
    clearSearchBtn.addEventListener('click', clearSearch);
    tableViewBtn.addEventListener('click', () => switchView('table'));
    cardViewBtn.addEventListener('click', () => switchView('card'));

    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', init);
  </script>
  <script type="module" src="/main.js"></script>
</body>
</html>